# AICore 架构设计记录

## 一、Model层改造（已完成）

### 改造内容
所有模型类继承 `BaseModel`，删除重复方法，保留各自特有功能。

### 已修改文件
| 文件 | 状态 | 说明 |
|------|------|------|
| deepseek.py | 已完成 | 保留特有的set_temperature(pattern)、token_callback |
| Kimi.py | 已完成 | 保留速率限制逻辑、token_callback |
| qwen.py | 已完成 | 保留extract_stream_info(带thinking)、token_callback |
| CharGPT.py | 已完成 | 使用tiktoken |
| claude.py | 已完成 | 使用tiktoken |
| Gemini.py | 已完成 | 使用tiktoken |
| mita.py | 已完成 | 使用tiktoken |
| doubao.py | 无需修改 | 已正确继承 |

---

## 二、Tool层架构设计（待实现）

### API差异对比

| 项目 | OpenAI | Claude (Anthropic) | Gemini (Google) |
|------|--------|-------------------|-----------------|
| SDK | openai | anthropic | google-generativeai |
| 调用方式 | chat.completions.create() | messages.create() | generate_content() |
| system消息 | 在messages数组中 | 单独顶级参数 | 不同方式 |
| assistant角色 | assistant | assistant | model |
| 历史管理 | 手动传入 | 手动传入 | 可手动(generate_content) |

### OpenAI兼容的API

以下API可直接使用 `openai_client.py`，只需修改 `base_url`：

| 厂商 | base_url | 说明 |
|------|----------|------|
| OpenAI | https://api.openai.com/v1 | 官方 |
| DeepSeek | https://api.deepseek.com/v1 | 兼容 |
| Kimi | https://api.moonshot.cn/v1 | 兼容 |
| 通义千问 | https://dashscope.aliyuncs.com/compatible-mode/v1 | 兼容 |
| 豆包 | https://ark.cn-beijing.volces.com/api/v3 | 兼容 |
| Grok (xAI) | https://api.x.ai/v1 | 兼容 |

### 结论
- 大部分国内模型都兼容OpenAI格式
- Claude、Gemini需要单独实现
- 管理功能可以抽取到基类

---

## 三、基类可继承的管理功能

### 1. Token统计
- 输入/输出token分别计数
- 累计使用量统计
- 按日/月统计

### 2. 额度管理
- 用户配额限制
- 超额警告/阻止
- 额度重置周期

### 3. 费用计算
- 各模型价格配置
- 输入/输出token价格
- 费用统计预警

### 4. 速率限制
- RPM（每分钟请求数）
- TPM（每分钟token数）
- 并发控制

### 5. 使用日志/审计
- 请求记录
- 用户、时间、模型信息

### 6. 异常监控
- 错误率统计
- 响应时间监控

### 7. 缓存管理
- 相同问题缓存
- 命中率统计

---

## 四、建议架构

```
Tool/
  ├── base_client.py       # 基类：管理功能（token统计、额度、日志等）
  ├── openai_client.py     # OpenAI兼容API（当前OPEN_AI.py）
  ├── anthropic_client.py  # Claude官方API
  └── google_client.py     # Gemini官方API
```

### 基类职责
- Token统计和额度管理
- 使用日志记录
- 输入验证
- 回调函数验证

### 子类职责
- 客户端初始化
- API调用实现
- 响应解析
- 流式处理
